<!DOCTYPE html>
<html lang="en">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Encrypted QR Generator</title>
    <meta name="description" content="An offline tool for creating AES256 encrypted QR backups">
    <meta name="author" content="Pawel Cioch">

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="icon" type="image/png" href="images/favicon.png">

    <script type="text/javascript" src="lib/gibberish-aes-1.0.0.min.js"></script>
    <script type="text/javascript" src="lib/qrious.min.js"></script>
    <script type="text/javascript" src="langs/lang-map.js"></script>
    <script type="text/javascript" src="lib/html5-qrcode.min.js"></script>

    <body>

        <div class="navbar navbar-inverse text-center">
            <div class="container">
                <div id="langMenu"></div>
                <div id="xtHeadTitle"></div>
                <div id="modes">
                    <button id="xtEncryption" class="button button-page" onclick="setMode(this)" disabled="disabled"></button>
                    <button id="xtDecryption" onclick="setMode(this)"></button>
                    <button id="xtNoEncryption" onclick="setMode(this)"></button>
                    <button id="xtTwoFactorUtility" onclick="setMode(this)"></button>
                    <button id="xtInfo" onclick="setMode(this)"></button>
                    <button id="xtDonate" onclick="setMode(this)"></button>
                </div>
                <span id="ver">v1.3.2</span>
            </div>
        </div>

        <div class="container">
            <div id="pageTools">
                <form name="qrForm" autocomplete="off" action="#" method="POST">
                    <div id="baseInputs">
                        <label>
                            <span id="xtPlainTextLabel"></span>
                            <span id="xtPlainTextLabel2" hidden></span>
                        </label>
                        <textarea name="plainText" id="xhtPlainTextHint" class="u-full-width" placeholder=""></textarea>
                        <div class="row">
                            <div class="six columns">
                                <label>
                                    <span id="xtQrLabel"></span>
                                    <span id="xtOptional">(Optional)</span>
                                </label>
                                <input type="text" name="qrLabel" class="u-full-width">
                            </div>
                            <div class="six columns">
                                <label>
                                    <span id="xtEmbedLabel"></span>
                                </label>
                                <input type="checkbox" name="isEmbed">
                            </div>
                        </div>
                        <label>
                            <span id="xtQrDescription"></span>
                            <span id="xtOptional"></span>
                        </label>
                        <textarea name="qrDescription" class="u-full-width"></textarea>
                    </div>
                    <div id="decryptInputs">
                        <div id="readerFloat" class="readerFloat u-full-width">
                            <div id="qr-input-layer" class="qr-input-layer">
                                <div id="cameraReaderControls" hidden>
                                    <label for="cameras">Select a camera to scan QR</label>
                                    <select id="cameras" hidden></select>
                                    <div id="reader" style="width: 500px"></div>
                                </div>
                                <div id="imageReaderControls" hidden>
                                    <label for="qr-input-file">Load encrypted data from QR image</label>
                                    <input type="file" id="qr-input-file" accept="image/*" class="u-full-width">
                                </div>
                                <div id="scanError" class="validationError center"></div>
                                <div class="center">
                                    <button id="xtClose" type="button" onclick="hideReaderFloat()" class="button center"></button>
                                </div>
                            </div>
                        </div>
                        <label>
                            <span id="xtEnterEncryptedKey"></span>
                        </label>
                        <textarea name="qrEncryptedText" id="xhtEncryptedTextHint" class="u-full-width"></textarea>
                        <div class="decryptFloat">
                            <img id="xttScanQrHint" class="scanQr" src="images/scan.png" onclick="scanFromCamera()" title="">
                            <button id="xtLoadQrImage" type="button" class="button" onclick="scanFromImage()"></button>
                        </div>
                    </div>
                    <div id="pharseInputs">
                        <label>
                            <span id="xtPharse"></span>
                        </label>
                        <input type="password" name="pharse" id="xhtPharseHint" class="u-full-width">
                        <label>
                            <span id="xtPharseConfirm"></span>
                        </label>
                        <input type="password" name="pharseConfirm" class="u-full-width">
                    </div>
                    <div id="twoFactorInputs">
                        <span id="xt2faInfo"></span>
                        <br>
                        <br>
                        <label>
                            <span id="xt2faAccountName"></span>
                        </label>
                        <input type="text" name="twoFactorAccountName" class="u-full-width" onkeypress="hide(twoFactorResult)">
                        <label>
                            <span id="xt2faSecretKey"></span>
                        </label>
                        <input type="text" name="twoFactorSecretKey" class="u-full-width" onkeypress="hide(twoFactorResult)">
                    </div>
                    <div class="row">
                        <div class="six columns">
                            <button id="xtGenerate" type="button" onclick="generate()" class="button-primary"></button>
                            <button id="xtDecrypt" type="button" onclick="decrypt()" class="button-primary" hidden></button>
                        </div>
                        <div class="six columns">
                            <button id="xtClearForm" type="button" onclick="clearForm('qrForm')" class="button u-pull-right"></button>
                        </div>
                    </div>
                    <div id="twoFactorResult" class="center" hidden>
                        <label>
                            <span id="xt2faPleaseScan"></span>
                        </label>
                        <img id="twoFactorQr" style="vertical-align: top;" />

                    </div>
                </form>

                <div id="qrResult" hidden>
                    <div id="qrSection" class="row">
                        <div id="printQr" class="nine columns">
                            <div id="qrHolder" style="background-color: white; border: 2px dashed black; padding: 20px; display: inline-block; margin-bottom: 20px; text-align: center; font-family: Arial; font-size: 15px; line-height: normal;">
                                <div id=qrResultLabel style="font-weight: bold; margin-bottom: 15px; word-break: break-all;">Label</div>
                                <img id="mainQr" alt="Encrypted QR" style="vertical-align: top;" />
                                <div id="qrResultDescription" style="word-break: break-all; margin-top: 20px;">Description</div>
                                <div id="qrPrintDate" style="margin-top: 20px; font-size: small;"></div>
                            </div>
                        </div>

                        <div class="three columns right printHide">
                            <div style="display: inline-block">
                                <label>
                                    <span id="xtAdjustQrSize" class="u-pull-left"></span>
                                </label>
                                <input id="adjustQrSize" type="number" onchange="adjustQr()">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <b id="xtHideDate">Hide Date</b>
                                <input id="hideDate" type="checkbox" onchange="hideDate()" style="margin: 5px;">
                            </div>
                            <div>
                                <button id="xtSaveQrImage" type="button" onclick="invokeSaveQrImage()" class="button-primary"></button>
                            </div>
                            <div>
                                <button id="xtSaveQrHtml" type="button" onclick="invokeSaveQrHtml()" class="button-primary"></button>
                            </div>
                            <div>
                                <button id="xtPrint" type="button" onclick="javascript:window.print();" class="button-primary"></button>
                            </div>
                            <a id="qrDownload" href="" download="" hidden></a>
                        </div>
                    </div>
                    <div class="printHide">
                        <label>
                            <span id="xtEncQrData"></span>
                            <span id="xtDecQrData" hidden></span>
                        </label>
                        <textarea id="qrData" class="u-full-width" readonly></textarea>
                        <div class="right">
                            <button id="xtClose" type="button" onclick="showResult(false)" class="button"></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="pageInfo" hidden>
                <iframe id="infoFrame" src="" height="0"></iframe>
                <!-- This can be used in FF without postMessage -->
                <!-- <iframe id="infoFrame" src="" onload="setIframeHeight()" scrolling="no"></iframe>  -->
            </div>
            <div id="pageDonate" class="page" hidden>
                <p id="xtDonationHeader"></p>
                <table>
                    <tr style="border-top: 1px solid #E1E1E1;">
						<td>
							<i class="sprite sprite-btc"></i>
						</td>
						<td>Bitcoin (BTC)</td>
						<td>
							<div class="donateQr">bc1qt8kd0ftz7y6rk6x7wwdm74v3848adhrhj3d42u</div>
						</td>
					</tr>
                    <tr>
						<td>
							<i class="sprite sprite-bch"></i>
						</td>
						<td>Bitcoin Cash (BCH)</td>
						<td>
							<div class="donateQr">qpxkjyjrxdcd57wrwez9wg7elu20gzvu4qn3j4t4rm</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-ltc"></i>
						</td>
						<td>LiteCoin (LTC)</td>
						<td>
							<div class="donateQr">LNYffmyYBacgQPdPyftSHt5KcC1WF2kpm4</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-dgb"></i>
						</td>
						<td>DigiByte (DGB)</td>
						<td>
							<div class="donateQr">DNVodL8gwAdNDPvuv6SNWptDbAywZwLoWU</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-sys"></i>
						</td>
						<td>Syscoin (SYS)</td>
						<td>
							<div class="donateQr">SNEJVqQVF3cMRZeQjuKPh1bjdJveqznTdY</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-zec"></i>
						</td>
						<td>ZCash (ZEC)</td>
						<td>
							<div class="donateQr">t1M18s2noGXd92v7xW4sYSRogV6T7HK6Bgj</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-xmr"></i>
						</td>
						<td>Monero (XMR)</td>
						<td>
							<div class="donateQr">4AVYbSPHYP9gZRLkdpXNuNAKVQNymntPJUSTguyXziF9WgJppVpKFoHJQVjJkZQ6NhTMzGz6gSjNGaCQvswMgLe9MhGVXRw</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-aeon"></i>
						</td>
						<td>Aeon (AEON)</td>
						<td>
							<div class="donateQr">WmtwWaaFimBed3WE776ScG9EUR4ATq38ZZPZPU62QpJdBpc2wnzjjJhht3qo9AYnYUFVHG3osdQHshSXLUmF4a961QGH25FGt</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-btcz"></i>
						</td>
						<td>BitcoinZ (BTCZ)</td>
						<td>
							<div class="donateQr">t1UvBc7s1qNAjY5deR2mmeGLnybEN8Bp6Lb</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-dash"></i>
						</td>
						<td>Dash (DASH)</td>
						<td>
							<div class="donateQr">Xksnyf9Jxhij65nsdopBJDQb2B1kqze5rJ</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-pivx"></i>
						</td>
						<td>PIVX (PIVX)</td>
						<td>
							<div class="donateQr">DB7DTG5Mg1K4CN12vxo1aoL97qQ4rWiXsX</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-xvg"></i>
						</td>
						<td>Verge (XVG)</td>
						<td>
							<div class="donateQr">DQMsdWDH4wHrKMa3f3QHHc1BQ1uLbWWMa2</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-xlm"></i>
						</td>
						<td>Stellar (XLM)</td>
						<td>
							<div class="donateQr">GDVMJK62FYXFKQC7FOVLP2HKX5QDWSIET6XWTIIEP3QY2S65CCBDNYNL</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-strax"></i>
						</td>
						<td>Stratis (STRAX)</td>
						<td>
							<div class="donateQr">SP2tUjxJdn7BjzEezrJtWhAbEu2iSttC48</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-btg"></i>
						</td>
						<td>Bitcoin Gold (BTG)</td>
						<td>
							<div class="donateQr">GcMHJaTKrLrk9RcyJ5SK7YaX1uJ92B3Ehi</div>
						</td>
					</tr>
					<tr>
						<td>
							<i class="sprite sprite-doge"></i>
						</td>
						<td>Dogecoin (DOGE)</td>
						<td>
							<div class="donateQr">D7YpAAF6k8R9jCgfDYu1UjEVdq6hnFPKSu</div>
						</td>
					</tr>
                </table>
            </div>
            <div id="validationError" class="validationError center"></div>
            <footer>
                <div class="securityCheck">
                    <span id="xtNotOffline"></span>
                </div>

                <div class="copyright">&copy; 2017-2020 Pawel Cioch |
                    <a target="_blank" href="https://github.com/skironDotNet/encrypted-qr-backup-generator">
                        <span id="xtDownloadSource">Download from GitHub</span>
                    </a>
                </div>
                <div>
                    <span id="xtCopyOthers">JavaScript copyrights are included in the source.</span>
                    <span id="xtNoWarranty">No warranty.</span>
                </div>
            </footer>
            <div class="printHide">
                <div id="saveOverlay">
                    <div id="xtSaveDialogCaption"></div>
                    <div class="saveOverlayBody">
                        <div id="hideNoCanvas" hidden>
                            <div>
                                <input id="qrAreaWithDetails" name="imgType" type="radio" value="1" checked="checked">
                                <label id="xtQrAreaWithDetails" for="qrAreaWithDetails"></label>
                            </div>
                            <div>
                                <input id="qrImageOnly" name="imgType" type="radio" value="0">
                                <label id="xtQrImageOnly" for="qrImageOnly"></label>
                            </div>
                        </div>
                        <div style="margin-top: 10px">
                            <label id="xtFileName" for="qrFileName"></label>
                            <input id="qrFileName" type="text" class="u-full-width">
                        </div>
                        <div style="margin-top: 10px">
                            <button id="xtSaveConfirm" type="button" onclick="saveQr()" class="button-primary u-pull-right"></button>
                            <button id="xtClose" type="button" onclick="showSaveDialog(false)" class="button u-pull-left"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="cover"></div>

        <script type="text/javascript">

            var qr = window.qr = new QRious({
                element: document.getElementById('mainQr'),
                size: 100,
                value: 'Nothing here!'
            });

            var twoFactorQr = window.twoFactorQr = new QRious({
                element: document.getElementById('twoFactorQr'),
                size: 125,
                value: ''
            });

            var qrData = getElement('qrData');

            var resultLabel = getElement("qrResultLabel");
            var resultDesc = getElement("qrResultDescription");
            var adjustQrSize = getElement('adjustQrSize');
            var validationError = getElement('validationError');
            var saveDialog = getElement('saveOverlay');
            var hideNoCanvas = getElement('hideNoCanvas');
            var cover = getElement('cover');
            var infoFrame = getElement('infoFrame');
            const scanError = getElement('scanError');
            const readerFloat = getElement('readerFloat');
            const fileinput = document.getElementById('qr-input-file');
            const cameras = document.getElementById('cameras');
            const cameraReaderControls = document.getElementById('cameraReaderControls');
            const imageReaderControls = document.getElementById('imageReaderControls');
            var option = document.createElement('option');
            var isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
            var isChrome = !!window.chrome;
            var isRunningFromFile = window.location.protocol == 'file:';
            const html5QrCode = new Html5Qrcode("reader");

            var currentMode = 'xtEncryption';
            var pages = ['Tools', 'Info', 'Donate'];
            var suppressHashChange = false;
            var baseTitle = document.title;

            const smImage = 1;
            const smHtml = 2;
            var qrSavingMode = smImage;
            var qrfileName = getElement('qrFileName');

            window.addEventListener("message", receiveMessage, false);
            window.onhashchange = hashChanged;

            var donationQrs = document.querySelectorAll(".donateQr");
            for(var i=0;i<donationQrs.length;i++) {
                donationQrs[i].addEventListener('mouseenter', showDonateQr); 
                donationQrs[i].addEventListener('mouseleave', hideDonateQr); 
            }

            fileinput.addEventListener('change', e => {
                if (e.target.files.length == 0) { // No file selected, ignore 
                    return;
                }

                // Use the first item in the list
                const imageFile = e.target.files[0];
                html5QrCode.scanFile(imageFile, /* showImage= */false)
                .then(qrCodeMessage => {
                    document.qrForm.qrEncryptedText.value = qrCodeMessage;
                    hideReaderFloat();
                })
                .catch(err => {
                    console.log(err);
                    document.qrForm.qrEncryptedText.value = '';
                    showScanError(translations['xtBadQrImage']);
                });
            });

            cameras.addEventListener('change', e => {
                startScanning(cameras.value);
            });

            function parseURL(url) {
                //from https://www.abeautifulsite.net/parsing-urls-in-javascript
                //plus my own modification

                var parser = document.createElement('a'),
                    searchObject = {},
                    queries, split, i;
                // Let the browser do the work
                parser.href = url;
                // Convert query string to object
                queries = parser.search.replace(/^\?/, '').split('&');
                for (i = 0; i < queries.length; i++) {
                    split = queries[i].split('=');
                    searchObject[split[0]] = split[1];
                }

                hashObject = parser.hash.replace(/^#/, '').split('/');

                return {
                    protocol: parser.protocol,
                    host: parser.host,
                    hostname: parser.hostname,
                    port: parser.port,
                    pathname: parser.pathname,
                    search: parser.search,
                    searchObject: searchObject,
                    hash: parser.hash,
                    hashObject: hashObject
                };
            }

            function setUrlHash(lang, page) {
                suppressHashChange = true;
                parent.location.hash = lang + '/' + page
            }

            function receiveMessage(event) {
                infoFrame.height = event.data;
            }

            function hashChanged(event) {
                if (suppressHashChange) {
                    suppressHashChange = false;
                    return;
                }

                loadLangFile(getLangFromUrl(), updateLang);
                setModeName(getModeFromUrl());
                suppressHashChange = false;
            }

            function generate() {
                switch (currentMode) {
                    case "xtEncryption":
                        doEnc();
                        break;
                    case "xtNoEncryption":
                        doPlain();
                        break;
                    case "xtTwoFactorUtility":
                        generate2FaQr();
                        break;
                }
            }

            function doPlain() {
                var plain = document.qrForm.plainText.value;

                if (document.qrForm.qrLabel.value.length > 0 && document.qrForm.isEmbed.checked) {
                    plain = document.qrForm.qrLabel.value + ':\n\n' + plain;
                }

                fillResultScreen(plain);
            }

            function doEnc() {
                var pharse = document.qrForm.pharse.value;
                var pharseConfim = document.qrForm.pharseConfirm.value;

                if (!validatePharse(pharse, pharseConfim))
                    return;

                var plain = document.qrForm.plainText.value;
                var encrypted = GibberishAES.enc(plain, pharse);

                if (document.qrForm.qrLabel.value.length > 0 && document.qrForm.isEmbed.checked) {
                    encrypted = document.qrForm.qrLabel.value + '\n\n-ENC BLOCK-\n\n' + encrypted;
                }

                fillResultScreen(encrypted);
            }

            function decrypt() {
                var pharse = document.qrForm.pharse.value;
                var pharseConfim = document.qrForm.pharseConfirm.value;

                if (!validatePharse(pharse, pharseConfim))
                    return;

                var plain = '';
                var encText = document.qrForm.qrEncryptedText.value;
                var encArr = encText.split('-ENC BLOCK-');
                var enc = encArr[encArr.length - 1].trim();

                try {
                    plain = GibberishAES.dec(enc, pharse);
                }
                catch (err) {
                    if (err === 'Decryption error: Maybe bad key') {
                        showValidationError('xtErrWrongPassphrase');
                        return;
                    }
                    else {
                        showValidationError('xtErrGenericDecryptError');
                        return;
                    }
                }

                var dataLineCount = plain.split(/\r\n|\r|\n/).length;

                qrData.value = plain;
                qrData.style.height = dataLineCount * 15 + 'px';
                showResult(true);
                setResultModeToDecrypt();
            }

            function scanFromCamera() {
                show(readerFloat);
                show(cameraReaderControls);
                if (isChrome && isRunningFromFile){
                    showScanError(translations['xtCameraChromeError']);
                    return;
                }


                Html5Qrcode.getCameras().then(devices => {
                    show(cameras);
                    cameras.innerHTML = '';
                    if (devices && devices.length) {
                        console.log(devices);
                        var defaultCameraId = devices[0].id;

                        var options = [];

                        devices.forEach(c => {
                            option.text = c.label;
                            option.value = c.id;
                            options.push(option.outerHTML);
                        });

                        cameras.insertAdjacentHTML('beforeEnd', options.join('\n'));
                        startScanning(defaultCameraId);
                    }
                    else {
                        console.log('devices && devices.length was false');
                        showScanError(translations['xtNoCamerasDetected']);
                    }
                }).catch(err => {
                    console.log(err);
                    if (err.includes('NotFoundError')) {
                        showScanError(translations['xtNoCamerasDetected']);
                    } else {
                        showScanError(err);
                    }
                });
            }

            function stopScanning() {
                var state = html5QrCode.getState();
                if (state == 2){
                    html5QrCode.stop();
                }
            }

            function startScanning(cameraId) {
                stopScanning();
                html5QrCode.start(
                cameraId,     // retreived in the previous step.
                {
                    fps: 15,    // sets the framerate to 10 frame per second
                    qrbox: 260  // sets only 250 X 250 region of viewfinder to
                                // scannable, rest shaded.
                },
                qrCodeMessage => {
                    document.qrForm.qrEncryptedText.value = qrCodeMessage;
                    hideReaderFloat();
                },
                errorMessage => {
                    // parse error, ideally ignore it. For example:
                    //console.log(`QR Code no longer in front of camera.`);
                    //NotReadableError : Could not start video source
                    //try to switch to next camera this one is busy, already running
                })
                .catch(err => {
                    // Start failed, handle it. For example,
                    var msg = `Unable to start scanning, error: ${err}`
                    console.log(msg);
                    showScanError(msg);
                });
            }

            function generate2FaQr() {
                var accountName = document.qrForm.twoFactorAccountName.value;
                var secretKey = document.qrForm.twoFactorSecretKey.value;

                if (!validate2Fa(accountName, secretKey)) {
                    return;
                }

                twoFactorQr.value = 'otpauth://totp/' + accountName + '?secret=' + secretKey;
                show(twoFactorResult);
            }

            function validate2Fa(accountName, secretKey) {
                clearValidationError();
                hide(twoFactorResult);

                if (accountName.length < 4) {
                    showValidationError('xtErr2FaAccountNameTooShort');
                    return false;
                }
                if (secretKey.length < 4) {
                    showValidationError('xtErr2FaSecretKeyNotPresent');
                    return false;
                }

                return true;
            }
            function fillResultScreen(qrValue) {

                var dataLineCount = qrValue.split(/\r\n|\r|\n/).length;

                qr.level = 'L';
                qr.size = 100 + dataLineCount * 15;
                adjustQrSize.value = qr.size;
                qr.value = qrValue;

                qrData.value = qrValue;
                qrData.style.height = dataLineCount * 15 + 'px';

                if (document.qrForm.qrLabel.value.length > 0 && !document.qrForm.isEmbed.checked) {
                    resultLabel.innerText = document.qrForm.qrLabel.value;
                    show(resultLabel);
                }
                else {
                    hide(resultLabel);
                }

                if (document.qrForm.qrDescription.value.length > 0) {
                    resultDesc.innerText = document.qrForm.qrDescription.value;
                    show(resultDesc);
                }
                else {
                    hide(resultDesc);
                }

                var date = new Date();
                getElement("qrPrintDate").innerHTML = translations['xtQrDateCreatedLabel'] + getDateString(date);
                setResultModeToEncrypt();
                showResult(true);
            }

            function getElement(id) {
                return document.getElementById(id);
            }

            function setMode(obj) {
                setModeName(obj.id)
            }

            function setModeName(name) {
                currentMode = name;
                highlightModeButton(name);
                switch (name) {
                    case "xtDecryption":
                        setDecryptionMode();
                        showPage('Tools');
                        setUrlHash(currentLangCode, "decrypt")
                        setPageTitle("Decryption");
                        break;
                    case "xtNoEncryption":
                        setNoEncyptionMode();
                        showPage('Tools');
                        setUrlHash(currentLangCode, "plain")
                        setPageTitle("Plain Data QR");
                        break;
                    case "xtInfo":
                        showPage('Info');
                        setUrlHash(currentLangCode, "info")
                        setPageTitle("Info");
                        break;
                    case "xtDonate":
                        showPage('Donate');
                        setUrlHash(currentLangCode, "donate")
                        setPageTitle("Donate");
                        break;
                    case "xtTwoFactorUtility":
                        set2FaMode();
                        showPage('Tools');
                        setUrlHash(currentLangCode, "2fa")
                        setPageTitle("Two Factor QR Generator");
                        break;
                    default:
                        setEncryptionMode();
                        showPage('Tools');
                        setUrlHash(currentLangCode, "encrypt")
                        setPageTitle("Encryption");
                        break;
                }
            }

            function setPageTitle(titleSuffix) {
                document.title = baseTitle + ' - ' + titleSuffix;
            }

            function getModeFromHashName(name) {
                if (name === undefined)
                    return "xtEncryption";

                switch (name.toLowerCase()) {
                    case "encrypt":
                        return "xtEncryption";
                    case "decrypt":
                        return "xtDecryption";
                    case "plain":
                        return "xtNoEncryption";
                    case "info":
                        return "xtInfo";
                    case "donate":
                        return "xtDonate";
                    case "2fa":
                        return "xtTwoFactorUtility";
                    default:
                        return "xtEncryption";
                }
            }

            function getModeFromUrl() {
                var parsedUrl = parseURL(parent.location);
                return getModeFromHashName(parsedUrl.hashObject[1])
            }

            function showPage(pageName) {
                for (var i = 0; i < pages.length; i++) {
                    var pageNode = getElement('page' + pages[i]);
                    if (pages[i] == pageName) {
                        show(pageNode);
                    }
                    else {
                        hide(pageNode);
                    }
                }

                if (pageName == 'Info') {
                    loadInfoPage();
                }
            }

            function hideDate() {
                if (getElement('hideDate').checked) {
                    hide(qrPrintDate)
                }
                else {
                    show(qrPrintDate)
                }
            }

            function getDateString(d) {
                var datestring = d.getFullYear() + '-' + ("0" + (d.getMonth() + 1)).slice(-2) + "-" + ("0" + d.getDate()).slice(-2);
                return datestring;
            }

            function setEncryptionMode() {
                show(baseInputs);
                hide(xtPlainTextLabel2);
                show(xtPlainTextLabel);
                getElement('xhtPlainTextHint').placeholder = translations['xhtPlainTextHint'];
                show(pharseInputs);
                show(xtGenerate);
                hide(xtDecrypt);
                hide(decryptInputs);
                hide(twoFactorInputs);
            }

            function setDecryptionMode() {
                hide(baseInputs);
                show(decryptInputs);
                show(pharseInputs);
                hide(xtGenerate);
                show(xtDecrypt);
                hide(twoFactorInputs);
            }

            function setNoEncyptionMode() {
                show(baseInputs);
                hide(xtPlainTextLabel);
                show(xtPlainTextLabel2);
                getElement('xhtPlainTextHint').placeholder = '';
                hide(pharseInputs);
                hide(decryptInputs);
                show(xtGenerate);
                hide(xtDecrypt);
                hide(twoFactorInputs);
            }

            function set2FaMode() {
                hide(baseInputs);
                hide(decryptInputs);
                hide(pharseInputs)
                show(twoFactorInputs);
            }

            function highlightModeButton(buttonId) {
                getElement("modes").childNodes.forEach((node) => {
                    node.className = "";
                    node.disabled = false;
                })
                var currButton = getElement(buttonId)
                currButton.className = "button button-page";
                currButton.disabled = true;

                if (buttonId == 'xtNoEncryption') {
                    currButton.className = "button button-page-red";
                }

                showResult(false);
                clearAllForms();
            }

            function showResult(bool) {
                if (bool) {
                    hide(qrForm);
                    show(qrResult);
                }
                else {
                    show(qrForm);
                    hide(qrResult);
                }
            }

            function setResultModeToDecrypt() {
                hide(qrSection);
                hide(xtEncQrData);
                show(xtDecQrData);
            }

            function setResultModeToEncrypt() {
                show(qrSection);
                show(xtEncQrData);
                hide(xtDecQrData);
            }

            function clearForm(formName) {
                document.forms.namedItem(formName).reset();
                clearValidationError();
                hide(twoFactorResult);
            }

            function clearAllForms() {
                for (i = 0; i < document.forms.length; i++) {
                    document.forms[i].reset();
                }
                clearValidationError();
                hide(twoFactorResult);                
            }

            function adjustQr() {
                if (adjustQrSize.value < 100)
                    adjustQrSize.value = 100;

                if (adjustQrSize.value > 600)
                    adjustQrSize.value = 600;

                qr.size = adjustQrSize.value;
            }

            function validatePharse(pharse, pharseConfirm) {
                clearValidationError();

                if (pharse.length < 25) {
                    showValidationError('xtErrPharseTooShort');
                    return false;
                }
                if (pharse != pharseConfirm) {
                    showValidationError('xtErrPharseNotMatch');
                    return false;
                }

                return true;
            }

            function showValidationError(errorId) {
                validationError.textContent = translations[errorId];
                currentValidationError = errorId;
            }

            function clearValidationError() {
                validationError.textContent = '';
                currentValidationError = '';
            }

            function invokeSaveQrImage() {
                setSaveDialogImageMode();
                showSaveDialog(true);
            }

            function invokeSaveQrHtml() {
                setSaveDialogHtmlMode();
                showSaveDialog(true);
            }

            function saveQr() {
                showSaveDialog(false);
                switch (qrSavingMode) {
                    case smImage:
                        if (getElement('qrAreaWithDetails').checked) {
                            var qrHolder = getElement('qrHolder');
                            saveQrArea(qrfileName.value, qrHolder);
                        }
                        else {
                            saveQrImage(qrfileName.value, qr.element.src);
                        }
                        break;
                    case smHtml:
                        saveQrHtml(qrfileName.value);
                        break;
                }

            }

            function saveQrImage(fileName, imageData) {
                if (fileName.length < 1) {
                    fileName = getDefaultFileName('');
                }

                var down = getElement('qrDownload');
                down.href = imageData;
                down.download = fileName.replace('.png', '') + '.png';
                down.click();
            }

            function saveQrHtml(fileName) {
                if (fileName.length < 1) {
                    fileName = getDefaultFileName('');
                }

                var qrHolder = getElement('qrHolder');
                var down = getElement('qrDownload');
                down.href = 'data:text/html;base64,' + btoa('<html><body>\r\n' + qrHolder.outerHTML + '\r\n</body></html>');
                down.download = fileName.replace('.html', '').replace('.htm', '') + '.html';
                down.click();
            }

            function getDefaultFileName(ext) {
                return 'qr-' + new Date().getTime() + ext;
            }

            function setSaveDialogImageMode() {
                qrSavingMode = smImage;
                qrfileName.value = getDefaultFileName('.png');

                if (isCanvasSupported()) {
                    show(hideNoCanvas);
                    getElement('qrAreaWithDetails').checked = true;
                }
                else {
                    hide(hideNoCanvas);
                    getElement('qrImageOnly').checked = true;
                }
            }

            function setSaveDialogHtmlMode() {
                qrSavingMode = smHtml;
                qrfileName.value = getDefaultFileName('.html');
                hide(hideNoCanvas);
            }

            function showSaveDialog(bool) {
                if (bool) {
                    show(saveDialog);
                    show(cover);
                }
                else {
                    hide(saveDialog);
                    hide(cover)
                }
            }

            function isOffline() {
                return isRunningFromFile 
                || window.location.hostname == 'localhost'
                || window.location.hostname == '127.0.0.1';
            }

            function securityCheck() {
                var secOffline = getElement('xtNotOffline')
                if (!isOffline()) {
                    show(secOffline);
                }
                else {
                    hide(secOffline);
                }
            }

            function show(element) {
                element.style.display = 'block';
            }

            function hide(element) {
                element.style.display = 'none';
            }

            function showDonateQr(event) {
                var parent = event.target.parentNode;
                var img = parent.querySelector('img');
                if (img) {
                    return;
                }

                var br = document.createElement('br');
                var img = document.createElement('img');
                var x = new QRious({
                    element: img,
                    size: 124,
                    value: event.target.innerText,
                });

                parent.appendChild(br);
                parent.appendChild(img);
            }

            function hideDonateQr(event) {
                var parent = event.target.parentNode;
                var img = parent.querySelector('img');
                var br = parent.querySelector('br');
                if (!img) {
                    return;
                }
                parent.removeChild(img);
                parent.removeChild(br);
            }

            function scanFromImage() {
                show(readerFloat);
                show(imageReaderControls);
            }

            function hideReaderFloat() {
                hide(readerFloat);
                hide(imageReaderControls);
                hide(cameraReaderControls);
                showScanError(null);
                fileinput.value = null;
                stopScanning();
            }

            function showScanError(message){
                debugger;
                scanError.innerHTML = message;
                if (message)
                    show(scanError);
                else
                    hide(scanError);
            }

            /*

            //Useful only in FF, Chrome will prevent access to iframe content for local file due to origin bug
            function setIframeHeight() {
                var x = getElement('infoFrame');
                x.height = 0; //need to reset because iframe keeps previous scrollHeight
                x.height = getDocHeight(x.contentWindow.document);
            }

            function getDocHeight(doc) {
                doc = doc || document;
                // stackoverflow.com/questions/1145850/
                var body = doc.body, html = doc.documentElement;
                var height = Math.max(body.scrollHeight, body.offsetHeight,
                    html.clientHeight, html.scrollHeight, html.offsetHeight);
                return height;
            }

            */

            function loadInfoPage() {
                infoFrame.height = 0; //reset so it can recalculate onLoand and pass back via postMessage
                infoFrame.src = 'langs/pages/info-' + currentLangCode + '.html';
            }

            //https://stackoverflow.com/a/2746983
            function isCanvasSupported() {
                var elem = document.createElement('canvas');
                return !!(elem.getContext && elem.getContext('2d'));
            }

            /*** Simple micro engine HTML to SVG and Image by Pawel Cioch ***/
            /*** Most of this is adjusted for the purpose of this tool, not an universal library ***/

            function isFireFox() {
                return typeof InstallTrigger !== 'undefined';
            }

            function saveQrArea(fileName, htmlNode) {
                var html = htmlNode.outerHTML.replace(/(<img [^>]+[^\/])>/gi, '$1 />'); //fix img to be closed tag XHTML
                html = html.replace(/<br\s*>/gi, '<br />'); //fix <br> to be closed tag XHTML


                var data = '<svg xmlns="http://www.w3.org/2000/svg" width="' + htmlNode.offsetWidth + '" height="' + htmlNode.offsetHeight + '">' +
                    '<foreignObject width="100%" height="100%">' +
                    '<div xmlns="http://www.w3.org/1999/xhtml">' +
                    html +
                    '</div>' +
                    '</foreignObject>' +
                    '</svg>';


                var canvas = document.createElement('canvas');
                canvas.width = htmlNode.offsetWidth;
                canvas.height = htmlNode.offsetHeight;
                var ctx = canvas.getContext('2d');

                var img = new Image();

                img.onload = function () {
                    ctx.drawImage(img, 0, 0);

                    if (isFireFox()) {
                        var imgQr = htmlNode.childNodes[3];
                        ctx.drawImage(imgQr, (htmlNode.offsetWidth / 2) - (imgQr.offsetHeight / 2), imgQr.offsetTop); //needed for FF, seems like SVG embed image is nor rendered, so appears blank
                    }

                    saveQrImage(fileName, canvas.toDataURL());
                }

                img.src = 'data:image/svg+xml;base64,' + btoa(data);
            }

            /*** End HTML to Image ***/

            /*** Simple Lang engine by Pawel Cioch ***/

            var langMenu = getElement('langMenu');
            var currentLangCode = null;
            var currentValidationError = '';

            function setLang(obj) {
                loadLangFile(obj.id, updateLang);
            }

            function loadLangFile(langCode, callback) {
                if (currentLangCode == langCode) {
                    return;
                }

                if (langCode == null || langCode == '') {
                    langCode = localStorage.getItem('qrlang');
                    if (langCode == null || langCode.length != 2) {
                        langCode = defaultLanguageCode;
                    }
                }

                showLangMenu(langCode);
                var head = document.getElementsByTagName('head')[0];

                var langScript = getElement("langFile");
                if (langScript !== null) {
                    head.removeChild(langScript);
                }

                var script = document.createElement('script');
                script.type = 'text/javascript';
                currentLangCode = langCode.toLowerCase();
                script.src = 'langs/' + currentLangCode + '.js?v=' + new Date().getTime();
                script.id = 'langFile';

                script.onreadystatechange = callback;
                script.onload = callback;

                head.appendChild(script);
                localStorage.setItem("qrlang", currentLangCode);
            }

            function showLangMenu(langSelected) {
                var html = '';
                langsAvailable.forEach(function (lang) {
                    if (langSelected == lang.Code)
                        html += '<span><a id="' + lang.Code + '" class="selected" onclick="setLang(this)">' + lang.Name + '</a></span> | '
                    else
                        html += '<span><a id="' + lang.Code + '" onclick="setLang(this)">' + lang.Name + '</a></span> | '
                }, this);

                langMenu.innerHTML = html.substring(0, html.length - 3);;
            }

            var updateLang = function () {
                var langElements = document.querySelectorAll('[id^=xt]');
                langElements.forEach(function (element) {
                    element.innerHTML = translations[element.id];
                }, this);

                langElements = document.querySelectorAll('[id^=xht]');
                langElements.forEach(function (element) {
                    element.placeholder = translations[element.id];
                }, this);

                langElements = document.querySelectorAll('img[id^=xtt]');
                langElements.forEach(function (element) {
                    element.title = translations[element.id];
                }, this);

                if (currentValidationError.length > 0) {
                    validationError.textContent = translations[currentValidationError];
                }

                loadInfoPage();

                setModeName(getModeFromUrl()); //needed on first load from url hash
                suppressHashChange = false; //need this as URL hash event can finish before lang reload
            };

            function getLangFromUrl() {
                var parsedUrl = parseURL(parent.location);
                const lang = langsAvailable.find(lang => lang.Code === parsedUrl.hashObject[0]);
                if (lang === undefined) {
                    var langCode = localStorage.getItem('qrlang');
                    if (langCode == null || langCode.length != 2) {
                        langCode = defaultLanguageCode;
                    }
                    return langCode
                }
                else {
                    return lang.Code;
                }
            }

            loadLangFile(getLangFromUrl(), updateLang);

            /*** End Lang Engine ***/

            securityCheck();
        </script>
    </body>

</html>
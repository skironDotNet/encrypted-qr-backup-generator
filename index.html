<!DOCTYPE html>
<html lang="en">

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>QR Based Backups</title>
    <meta name="description" content="An offline tool for creating AES256 encrypted QR backups">
    <meta name="author" content="Pawel Cioch">

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="icon" type="image/png" href="images/favicon.png">

    <script type="text/javascript" src="lib/gibberish-aes-1.0.0.min.js"></script>
    <script type="text/javascript" src="lib/qrious.min.js"></script>
    <script type="text/javascript" src="langs/lang-map.js"></script>

    <body>

        <div class="navbar navbar-inverse text-center">
            <div class="container">
                <div id="langMenu"></div>
                <div id="xtHeadTitle"></div>
                <div id="modes">
                    <button id="xtEncryption" class="button button-page" onclick="setMode(this)" disabled="disabled"></button>
                    <button id="xtDecryption" onclick="setMode(this)"></button>
                    <button id="xtNoEncryption" onclick="setMode(this)"></button>
                    <button id="xtAbout" onclick="setMode(this)" class="u-pull-right"></button>
                </div>
            </div>
        </div>

        <div class="container">
            <form name="qrForm" autocomplete="off" action="#">
                <div id="baseInputs">
                    <label>
                        <span id="xtPlainTextLabel"></span>
                        <span id="xtPlainTextLabel2" hidden></span>
                    </label>
                    <textarea name="plainText" id="xhtPlainTextHint" class="u-full-width" placeholder=""></textarea>
                    <div class="row">
                        <div class="six columns">
                            <label>
                                <span id="xtQrLabel"></span>
                                <span id="xtOptional">(Optional)</span>
                            </label>
                            <input type="text" name="qrLabel" class="u-full-width">
                        </div>
                        <div class="six columns">
                            <label>
                                <span id="xtEmbedLabel"></span>
                            </label>
                            <input type="checkbox" name="isEmbed">
                        </div>
                    </div>
                    <label>
                        <span id="xtQrDescription"></span>
                        <span id="xtOptional"></span>
                    </label>
                    <textarea name="qrDescription" class="u-full-width"></textarea>
                </div>
                <div id="decryptInputs" hidden>
                    <label>
                        <span id="xtEnterEncryptedKey"></span>
                    </label>
                    <textarea name="qrEncryptedKey" id="xhtEncryptedKeyHint" class="u-full-width"></textarea>
                    <div class="decryptFloat">
                        <img id="xttScanQrHint" class="scanQr" src="images/scan.png" onclick="scanFromCamera()" title="">
                        <button id="xtLoadQrImage" class="button" onclick="loadQrImage()"></button>
                    </div>
                </div>
                <div id="pharseInputs">
                    <label>
                        <span id="xtPharse"></span>
                    </label>
                    <input type="password" name="pharse" id="xhtPharseHint" class="u-full-width">
                    <label>
                        <span id="xtPharseConfirm"></span>
                    </label>
                    <input type="password" name="pharseConfirm" class="u-full-width">
                </div>
                <div id="validationError" class="validationError center"></div>
                <div class="row">
                    <div class="six columns">
                        <button id="xtGenerate" type="button" onclick="generate()" class="button-primary"></button>
                        <button id="xtDecrypt" type="button" onclick="decrypt()" class="button-primary" hidden></button>
                    </div>
                    <div class="six columns">
                        <button id="xtClearForm" type="button" onclick="clearForm()" class="button u-pull-right"></button>
                    </div>
                </div>
            </form>

            <div id="qrResult" hidden>
                <div class="row">
                    <div id="printQr" class="nine columns">
                        <div id="qrHolder" style="background-color: white; border: 1px dashed grey; padding: 20px; display: inline-block; margin-bottom: 20px; text-align: center; font-family: Arial; font-size: 15px; line-height: normal;">
                            <div id=qrResultLabel style="font-weight: bold; margin-bottom: 15px; word-break: break-all;">Label</div>
                            <img id="qrious" alt="Encrypted QR" style="vertical-align: top;" />
                            <div id="qrResultDescription" style="word-break: break-all; margin-top: 20px;">Description</div>
                            <div id="qrPrintDate" style="margin-top: 20px;"></div>
                        </div>
                    </div>

                    <div class="three columns result-controls">
                        <div style="display: inline-block">
                            <label>
                                <span id="xtAdjustQrSize" class="u-pull-left"></span>
                            </label>
                            <input id="adjustQrSize" type="number" onchange="adjustQr()">
                        </div>
                        <div>
                            <button id="xtSaveQr" type="button" onclick="invokeSaveQr()" class="button-primary"></button>
                        </div>
                        <div>
                            <button id="xtPrint" type="button" onclick="javascript:window.print();" class="button-primary"></button>
                        </div>
                        <div>
                            <button id="xtClose" type="button" onclick="showResult(false)" class="button"></button>
                        </div>
                        <a id="qrDownload" href="" download="" hidden></a>
                    </div>
                </div>

                <label>
                    <span id="xtEncQrData"></span>
                </label>
                <textarea id="qrData" class="u-full-width" readonly></textarea>
            </div>

            <footer>
                <div class="securityCheck">
                    <span id="xtNotOffline"></span>
                </div>

                <div class="copyright">&copy; 2017 Pawel Cioch |
                    <a href="#">
                        <span id="xtDownloadSource">Download from GitHub</span>
                    </a>
                </div>
                <div>
                    <span id="xtCopyOthers">JavaScript copyrights are included in the source.</span>
                    <span id="xtNoWarranty">No warranty.</span>
                </div>
            </footer>
            <div class="printHide">
                <div id="saveOverlay">
                    <div id="xtSaveDialogCaption"></div>
                    <div class="saveOverlayBody">
                        <div id="hideNoCanvas" hidden>
                            <div>
                                <input id="qrAreaWithDetails" name="imgType" type="radio" value="1" checked="checked">
                                <label id="xtQrAreaWithDetails" for="qrAreaWithDetails"></label>
                            </div>
                            <div>
                                <input id="qrImageOnly" name="imgType" type="radio" value="0">
                                <label id="xtQrImageOnly" for="qrImageOnly"></label>
                            </div>
                        </div>
                        <div style="margin-top: 10px">
                            <label id="xtFileName" for="qrFileName"></label>
                            <input id="qrFileName" type="text" class="u-full-width">
                        </div>
                        <div style="margin-top: 10px">
                            <button id="xtSaveConfirm" type="button" onclick="saveQr()" class="button-primary u-pull-right"></button>
                            <button id="xtClose" type="button" onclick="showSaveDialog(false)" class="button u-pull-left"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="cover"></div>

        <script type="text/javascript">

            var qr = window.qr = new QRious({
                element: document.getElementById('qrious'),
                size: 100,
                value: 'Nothing here!'
            });

            var qrData = getElement('qrData');

            var resultLabel = getElement("qrResultLabel");
            var resultDesc = getElement("qrResultDescription");
            var adjustQrSize = getElement('adjustQrSize');
            var validationError = getElement('validationError');
            var saveDialog = getElement('saveOverlay');
            var hideNoCanvas = getElement('hideNoCanvas');
            var cover = getElement('cover');

            function generate() {
                switch (currentMode) {
                    case "xtEncryption":
                        doEnc();
                        break;
                    case "xtNoEncryption":
                        doPlain();
                        break;
                }
            }

            function doPlain() {
                var plain = document.qrForm.plainText.value;

                if (document.qrForm.qrLabel.value.length > 0 && document.qrForm.isEmbed.checked) {
                    plain = document.qrForm.qrLabel.value + ':\n\n' + plain;
                }

                fillResultScreen(plain);
            }

            function doEnc() {
                var pharse = document.qrForm.pharse.value;
                var pharseConfim = document.qrForm.pharseConfirm.value;

                if (!validatePharse(pharse, pharseConfim))
                    return;

                var plain = document.qrForm.plainText.value;
                var encrypted = GibberishAES.enc(plain, pharse);

                if (document.qrForm.qrLabel.value.length > 0 && document.qrForm.isEmbed.checked) {
                    encrypted = document.qrForm.qrLabel.value + '\n\n-ENC BLOCK-\n\n' + encrypted;
                }

                fillResultScreen(encrypted);
            }

            function scanFromCamera() {
                javascript: alert('Not implemented yet.');
            }

            function loadQrImage() {
                scanFromCamera();
            }

            function fillResultScreen(qrValue) {

                var dataLineCount = qrValue.split(/\r\n|\r|\n/).length;

                qr.level = 'L';
                qr.size = 100 + dataLineCount * 15;
                adjustQrSize.value = qr.size;
                qr.value = qrValue;

                qrData.value = qrValue;
                qrData.style.height = dataLineCount * 15 + 'px';

                if (document.qrForm.qrLabel.value.length > 0 && !document.qrForm.isEmbed.checked) {
                    resultLabel.innerText = document.qrForm.qrLabel.value;
                    show(resultLabel);
                }
                else {
                    hide(resultLabel);
                }

                if (document.qrForm.qrDescription.value.length > 0) {
                    resultDesc.innerText = document.qrForm.qrDescription.value;
                    show(resultDesc);
                }
                else {
                    hide(resultDesc);
                }

                var date = new Date();
                getElement("qrPrintDate").innerHTML = date.toLocaleFormat('%Y-%m-%d');
                showResult(true);
            }

            function getElement(id) {
                return document.getElementById(id);
            }

            var currentMode = 'xtEncryption';

            function setMode(obj) {
                currentMode = obj.id;

                highlightModeButton(currentMode);
                switch (currentMode) {
                    case "xtEncryption":
                        setEncryptionMode();
                        break;
                    case "xtDecryption":
                        setDecryptionMode();
                        break;
                    case "xtNoEncryption":
                        setNoEncyptionMode();
                        break;
                }
            }

            function setEncryptionMode() {
                show(baseInputs);
                hide(xtPlainTextLabel2);
                show(xtPlainTextLabel);
                getElement('xhtPlainTextHint').placeholder = translations['xhtPlainTextHint'];
                show(pharseInputs);
                show(xtGenerate);
                hide(xtDecrypt);
            }

            function setDecryptionMode() {
                hide(baseInputs);
                show(decryptInputs);
                show(pharseInputs);
                hide(xtGenerate);
                show(xtDecrypt);
            }

            function setNoEncyptionMode() {
                show(baseInputs);
                hide(xtPlainTextLabel);
                show(xtPlainTextLabel2);
                getElement('xhtPlainTextHint').placeholder = '';
                hide(pharseInputs);
                hide(decryptInputs);
                show(xtGenerate);
                hide(xtDecrypt);
            }

            function highlightModeButton(buttonId) {
                getElement("modes").childNodes.forEach((node) => {
                    node.className = "";
                    node.disabled = false;
                })
                var currButton = getElement(buttonId)
                currButton.className = "button button-page";
                currButton.disabled = true;

                if (buttonId == 'xtNoEncryption') {
                    currButton.className = "button button-page-red";
                }

                showResult(false);
                clearForm();
            }

            function showResult(bool) {
                if (bool) {
                    hide(qrForm);
                    show(qrResult);
                }
                else {
                    show(qrForm);
                    hide(qrResult);
                }
            }

            function clearForm() {
                document.qrForm.reset();
                clearValidationError();
            }

            function adjustQr() {
                if (adjustQrSize.value < 100)
                    adjustQrSize.value = 100;

                if (adjustQrSize.value > 600)
                    adjustQrSize.value = 600;

                qr.size = adjustQrSize.value;
            }

            function validatePharse(pharse, pharseConfirm) {
                clearValidationError();

                if (pharse.length < 25) {
                    validationError.textContent = translations.xtErrPharseTooShort;
                    currentValidationError = 'xtErrPharseTooShort';
                    return false;
                }
                if (pharse != pharseConfirm) {

                    validationError.textContent = translations.xtErrPharseNotMatch;
                    currentValidationError = 'xtErrPharseNotMatch';
                    return false;
                }

                return true;
            }

            function clearValidationError() {
                validationError.textContent = '';
                currentValidationError = '';
            }


            function invokeSaveQr() {
                getElement('qrFileName').value = getDefaultFileName();
                showSaveDialog(true);
            }

            function saveQr() {
                showSaveDialog(false);
                if (getElement('qrAreaWithDetails').checked) {
                    var qrHolder = getElement('qrHolder');
                    saveQrArea(qrHolder);
                }
                else {
                    saveQrImage(getElement('qrFileName').value, qr.element.src);
                }
            }

            function saveQrImage(fileName, imageData) {
                if (fileName.length < 1) {
                    fileName = getDefaultFileName();
                }
                var down = getElement('qrDownload');
                down.href = imageData;
                down.download = fileName.replace('.png', '') + '.png';
                down.click();
            }

            function getDefaultFileName() {
                return 'qr-' + new Date().getTime() + '.png';
            }

            function showSaveDialog(bool) {
                if (bool) {
                    show(saveDialog);
                    show(cover);

                    if (isCanvasSupported()) {
                        hideNoCanvas.style.display = 'block';
                        getElement('qrAreaWithDetails').checked = true;
                    }
                    else {
                        hideNoCanvas.style.display = 'none';
                        getElement('qrImageOnly').checked = true;
                    }
                }
                else {
                    hide(saveDialog);
                    hide(cover)
                }
            }

            function isOffline() {
                return window.location.protocol == 'file:';
            }

            function securityCheck() {
                var secOffline = getElement('xtNotOffline')
                if (!isOffline()) {
                    secOffline.style.display = 'block';
                }
                else {
                    secOffline.style.display = 'none';
                }
            }

            function show(element) {
                element.style.display = 'block';
            }

            function hide(element) {
                element.style.display = 'none';
            }

            //https://stackoverflow.com/a/2746983
            function isCanvasSupported() {
                var elem = document.createElement('canvas');
                return !!(elem.getContext && elem.getContext('2d'));
            }

            /*** Simple micro engine HTML to SVG and Image by Pawel Cioch ***/
            /*** Most of this is adjusted for the purpose of this tool, not an universal library ***/

            function isFireFox() {
                return typeof InstallTrigger !== 'undefined';
            }

            function saveQrArea(htmlNode) {
                var html = htmlNode.outerHTML.replace(/(<img [^>]+[^\/])>/gi, '$1 />'); //fix img to be closed tag XHTML
                html = html.replace(/<br\s*>/gi, '<br />'); //fix <br> to be closed tag XHTML


                var data = '<svg xmlns="http://www.w3.org/2000/svg" width="' + htmlNode.offsetWidth + '" height="' + htmlNode.offsetHeight + '">' +
                    '<foreignObject width="100%" height="100%">' +
                    '<div xmlns="http://www.w3.org/1999/xhtml">' +
                    html +
                    '</div>' +
                    '</foreignObject>' +
                    '</svg>';


                var canvas = document.createElement('canvas');
                canvas.width = htmlNode.offsetWidth;
                canvas.height = htmlNode.offsetHeight;
                var ctx = canvas.getContext('2d');

                var img = new Image();

                img.onload = function () {
                    ctx.drawImage(img, 0, 0);

                    if (isFireFox()) {
                        var imgQr = htmlNode.childNodes[3];
                        ctx.drawImage(imgQr, (htmlNode.offsetWidth / 2) - (imgQr.offsetHeight / 2), imgQr.offsetTop); //needed for FF, seems like SVG embed image is nor rendered, so appears blank
                    }

                    saveQrImage(getElement('qrFileName').value, canvas.toDataURL());
                }

                img.src = 'data:image/svg+xml;base64,' + btoa(data);
            }

            /*** End HTML to Image ***/

            /*** Simple Lang engine by Pawel Cioch ***/

            var langMenu = getElement('langMenu');
            var currentLangCode = '';
            var currentValidationError = '';

            function setLang(obj) {
                loadLangFile(obj.id, updateLang);
            }

            function loadLangFile(langCode, callback) {
                if (langCode == null) {
                    langCode = localStorage.getItem('qrlang');
                    if (langCode == null || langCode.length != 2) {
                        langCode = defaultLanguageCode;
                    }
                }

                showLangMenu(langCode);
                var head = document.getElementsByTagName('head')[0];

                var langScript = getElement("langFile");
                if (langScript !== null) {
                    head.removeChild(langScript);
                }

                var script = document.createElement('script');
                script.type = 'text/javascript';
                currentLangCode = langCode.toLowerCase();
                script.src = 'langs/' + currentLangCode + '.js?v=' + new Date().getTime();
                script.id = 'langFile';

                script.onreadystatechange = callback;
                script.onload = callback;

                head.appendChild(script);
                localStorage.setItem("qrlang", currentLangCode);
            }

            function showLangMenu(langSelected) {
                var html = '';
                langsAvailable.forEach(function (lang) {
                    if (langSelected == lang.Code)
                        html += '<span><a href="#" id="' + lang.Code + '" class="selected" onclick="setLang(this)">' + lang.Name + '</a></span> | '
                    else
                        html += '<span><a href="#" id="' + lang.Code + '" onclick="setLang(this)">' + lang.Name + '</a></span> | '
                }, this);

                langMenu.innerHTML = html.substring(0, html.length - 3);;
            }

            var updateLang = function () {
                var langElements = document.querySelectorAll('[id^=xt]');
                langElements.forEach(function (element) {
                    element.innerHTML = translations[element.id];
                }, this);

                langElements = document.querySelectorAll('[id^=xht]');
                langElements.forEach(function (element) {
                    element.placeholder = translations[element.id];
                }, this);

                langElements = document.querySelectorAll('img[id^=xtt]');
                langElements.forEach(function (element) {
                    element.title = translations[element.id];
                }, this);

                if (currentValidationError.length > 0) {
                    validationError.textContent = translations[currentValidationError];
                }
            };

            loadLangFile(null, updateLang);

            /*** End Lang Engine ***/

            securityCheck();
        </script>
    </body>

</html>